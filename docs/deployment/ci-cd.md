# CI/CD

::: details Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ CI/CD?

CI/CD (Continuous Integration, Continuous Delivery â€” Ð½ÐµÐ¿Ñ€ÐµÑ€Ñ‹Ð²Ð½Ð°Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð¸ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ°) â€” ÑÑ‚Ð¾ Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð±Ð¸Ð»Ð´Ð°, Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.

Ð”Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸, Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð»ÐµÐ¶Ð°Ñ‰ÐµÐ³Ð¾ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ ÐºÐ¾Ð´Ð° Ð² Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚ Ð½Ð° Ð¾Ð±Ð»Ð°Ñ‡Ð½Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€.

Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ CI/CD Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´ÐµÐ²Ð¾Ð¿Ñ Ð¸Ð½Ð¶ÐµÐ½ÐµÑ€Ñƒ, Ð½Ð¾ Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´ÐµÑ€Ñƒ, Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑ ÐµÐ¼Ñƒ Ð¿Ð¾ÑÐ»Ðµ git commit/push Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÐºÐ¾Ð´Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÑÐ°Ð¹Ñ‚, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð½Ð° GitHub Pages Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹.

ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ CI/CD: GitHub Actions, GitLab CI/CD, Jenkins, Trevis

:::

::: details GitHub Actions - Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° GitHub Pages

`GitHub Actions` Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹ Ð¸ ÑƒÐ´Ð¾Ð±Ð½Ñ‹, Ñ‚Ð°Ðº Ñ‡Ñ‚Ð¾ ÑÐ¾Ð²ÐµÑ‚ÑƒÐµÑ‚ÑÑ Ð¸Ñ… Ð¸Ð·ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÐºÐ°Ðº Ð² Ð¿ÐµÑ‚, Ñ‚Ð°Ðº Ð¸ Ð² Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… ÐºÐ¾Ð¼Ð¼ÐµÑ€Ñ‡ÐµÑÐºÐ¸Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°Ñ….

Ð’Ð°Ñˆ ÐºÐ¾Ð´ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð° GitHub, ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾.

Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ñ„Ð°Ð¹Ð» `.github/workflows/deploy.yaml`

Ð’ Ð½ÐµÐ¼ Ð±ÑƒÐ´ÑƒÑ‚ GitHub Actions Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸.

ÐžÐ±Ñ€Ð°Ð·ÐµÑ† ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Vue-Faq)

```yaml
# .github/workflows/deploy.yaml

name: Build and Deploy
on:
  push:
    branches: [main]
permissions:
  contents: write
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        id: pnpm-install
        with:
          version: 8.5.0
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - run: pnpm build

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs/.vitepress/dist
          branch: gh-pages
```

ÐŸÐ¾ÑÐ»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿ÑƒÑˆÐ° Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ ÑÐ°Ð¹Ñ‚Ð° Ð½Ð° GitHub Pages.

Ð’ Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ñ‚Ñ€Ð¸ GitHub Actions: `actions/checkout@v3` Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²Ð°ÑˆÐµÐ³Ð¾ ÐºÐ¾Ð´Ð° Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð· Ð²ÐµÑ‚ÐºÐ¸ `main`, `pnpm/action-setup@v2` Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ `pnpm` Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°, `JamesIves/github-pages-deploy-action@v4` Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð±Ð¸Ð»Ð´Ð° Ð² `gh-pages` Ð²ÐµÑ‚ÐºÑƒ Ð²Ð°ÑˆÐµÐ³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (Ð¾Ð½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° ÑƒÐ¶Ðµ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð°). Ð’Ð°Ñˆ GitHub Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ GitHub Pages Ð±Ñ€Ð°Ð»Ð¸ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· ÑÑ‚Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸ (`Settings->Pages`).

Ð’ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ GitHub Pages Ð¾Ð¿Ð¸ÑÐ°Ð½ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ‡ÐµÑ€ÐµÐ· Github Actions, Ð½Ð¾ `JamesIves/github-pages-deploy-action@v4`Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ¿Ñ€Ð¾Ñ‰Ð°ÐµÑ‚ Ð¶Ð¸Ð·Ð½ÑŒ.

:::

::: details GitHub Actions - Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ð¾ SSH

Ð‘Ð¾Ð»ÐµÐµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð¿Ð¾Ð»ÐµÐ·Ð½Ð¾Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° CI/CD.

Ð£ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¹ (`dev`, `staging`, `prod`) Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑŒ Ð² Ñ€ÑƒÑ‡Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ `workflow_dispatch`) Ð² Ð½ÑƒÐ¶Ð½Ð¾Ðµ Ð¿Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ñƒ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ ÑÐ¾ ÑÐ²Ð¾Ð¸Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸. ÐŸÐ»ÑŽÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑÑ Ð½Ð° `dev` Ð¿Ñ€Ð¸ `git push`.

Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ ÐµÑÑ‚ÑŒ ÑÐ²Ð¾Ð¹ `.env` Ñ„Ð°Ð¹Ð» - `.env.dev`, `.env.staging` Ð¸ `.env.prod`, Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸ÑŽ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÐ²Ð¾Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ - `dev.your-site.com`, `staging.your-site.com` Ð¸ `your-site.com`.

ÐšÑ€Ð¾Ð¼Ðµ Ñ‚Ð¾Ð³Ð¾, Ñ‚Ð°Ð¼ Ð¶Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ ÐµÑÑ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ `backup` Ñ Ð¿Ð¾Ð´Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÐ¼Ð¸ `dev`, `staging` Ð¸ `prod`. ÐŸÑ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ Ð¼Ñ‹ Ð±ÑƒÐ´ÐµÐ¼ Ð±ÑÐºÐ°Ð¿Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚Ð°Ð¼ 5 Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð² Ð´Ð»Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ÐºÐ°Ñ‚Ð° Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸.

ÐšÑ€Ð¾Ð¼Ðµ Ñ‚Ð¾Ð³Ð¾, Ð¼Ñ‹ Ð±ÑƒÐ´ÐµÐ¼ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» `build.json` Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð°Ñ‚Ð¾Ð¹ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼ Ð¸, Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð¸Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹. ÐžÐ½ Ð½ÑƒÐ¶ÐµÐ½ ÐºÐ°Ðº Ð´Ð»Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ñ†ÐµÐ»Ð¸, Ñ‚Ð°Ðº Ð¸ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð¾Ð¼ Ñ„Ð°Ð¹Ð»Ð° `index.html` Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ ÑÐ°Ð¹Ñ‚Ð° Ð¿Ð¾ÑÐ»Ðµ ÐµÐ³Ð¾ Ñ„Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð°Ð¿Ð´ÐµÐ¹Ñ‚Ð°. ÐžÐ´Ð½Ð¾ Ð¸Ð· Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ - Ð²ÐµÐ±ÑÐ°Ð¹Ñ‚ Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ ÑÑ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð´Ð°Ñ‚Ñƒ Ð² Ð½ÐµÐ¼ Ñ Ñ‚Ð¾Ð¹, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¾Ð½ Ñ€Ð°Ð½ÐµÐµ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ð» Ð² localStorage. Ð•ÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚, Ñ‚Ð¾ ÑÐ°Ð¹Ñ‚ Ñ„Ð¾Ñ€ÑÐ¸Ñ€ÑƒÐµÑ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ `index.html` Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð½Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ñ‚Ð°Ð¹Ð¼ÑÑ‚ÐµÐ¼Ð¿Ð°. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÐµÐ±ÑÐ°Ð¹Ñ‚Ð°.

```js
const localStorageName = "BUILD_DATE";
fetch("/build.json?version").then((response) => {
  response.json().then((buildData) => {
    if (buildData.date !== localStorage.getItem(localStorageName)) {
      console.log("Updating. New version:", buildData.date);
      localStorage.setItem(localStorageName, buildData.date);
      window.location.reload();
      throw new Error("Exiting for update");
    }
  });
});
```

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ñ‚Ñ€Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Github Actions: `appleboy/ssh-action@master` Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¼ Ñ…Ð¾ÑÑ‚Ðµ, `easingthemes/ssh-deploy@main` Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ…Ð¾ÑÑ‚, Ð¸ `snickerbockers/submodules-init@v4` - Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ Ð½Ð°Ñˆ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Git Submodules

ÐšÑ€Ð¾Ð¼Ðµ Ñ‚Ð¾Ð³Ð¾ Ð½Ð°Ð´Ð¾ Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Github Secrets SERVER_SSH_KEY_ROME - Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ…Ð¾ÑÑ‚.

::: details deploy.yaml

```yaml
# .github/workflows/deploy.yaml

name: Build and deploy
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: Target
        required: true
        default: dev
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      TARGET: ${{ inputs.target }}
      HOST: your-site.com
      TARGET_DIR: ${{ format('/var/www/your-site/{0}.your-site.com', inputs.target) }}
      PROJECT_DIR: ${{ format('{0}.your-site.com', inputs.target) }}
      REMOTE_USER: ubuntu
      SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
      ENV_FILE: ${{ format('.env.{0}', inputs.target) }}
    steps:
      - name: Setting the environment
        run: |
          echo $TARGET
          # deploy on Dev by default
          if [[ $TARGET == "" ]]
          then
            echo "TARGET_DIR=/var/www/your-site/dev.your-site.com" >> $GITHUB_ENV
            echo "PROJECT_DIR=dev.your-site.com" >> $GITHUB_ENV
            echo "ENV_FILE=.env.dev" >> $GITHUB_ENV
          fi          
          if [[ $TARGET == "prod" ]]
          then
            echo "TARGET_DIR=/var/www/your-site/your-site.com" >> $GITHUB_ENV
            echo "PROJECT_DIR=your-site.com" >> $GITHUB_ENV
          fi
      - run: |
          echo "target dir: $TARGET_DIR"
          echo "project dir: $PROJECT_DIR"
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - uses: snickerbockers/submodules-init@v4

      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 8.5.0
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - run: mv $ENV_FILE .env
      - run: pnpm build

      - name: Clean up the server dir
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          envs: TARGET_DIR
          script: sudo rm -rf $TARGET_DIR; mkdir $TARGET_DIR

      - name: Transfer files
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ env.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ env.HOST }}
          REMOTE_USER: ${{ env.REMOTE_USER }}
        env:
          SOURCE: dist/
          TARGET: ${{ env.TARGET_DIR }}
          EXCLUDE: ".git, .github, .vscode, *.md, *.yaml, *.sql, .gitignore"

      - name: After deploy scripts
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          envs: TARGET_DIR,REMOTE_USER,PROJECT_DIR
          script: |
            cd $TARGET_DIR
            pwd
            sudo chgrp -R www-data * .*
            backup_date=`date "+%Y-%m-%d__%H-%M-%S"`;
            printf "{\"website\": \"$PROJECT_DIR\", \"date\": \"$backup_date\"}" > build.json
            # -------------------
            root_backup_dir=`echo "/var/www/your-site/backup/$PROJECT_DIR"`;
            backup_dir=`echo "$root_backup_dir/$backup_date"`;
            mkdir $backup_dir -p;
            cp -rf $TARGET_DIR/* $backup_dir;
            sudo chgrp -R www-data $backup_dir;
            backups_remove_count=5;
            cd $backup_dir && rm -rf work logs images;
            cd $root_backup_dir && dirs_to_be_removed=`ls -dt "$root_backup_dir/"* | tail -n +$backups_remove_count`;
            rm $dirs_to_be_removed -rf;
```

:::
